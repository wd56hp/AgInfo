<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AgInfo Map</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha512-sA+e2atE5G0uQvECOH3yZG+GICJk12bnl5jwELyhlHLLJoPLD114F8CbnMD4PlzyBbs6k8ZZr3Su2VIsA5x5mQ=="
    crossorigin=""
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    #filter-control {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 2000;
      background: white;
      padding: 12px;
      border-radius: 5px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
      font-family: Arial, sans-serif;
      font-size: 14px;
      min-width: 220px;
    }
    #filter-control label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    #filter-control select {
      width: 200px;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <div id="filter-control">
    <div style="margin-bottom: 10px;">
      <a href="aginfo-starburst.html" style="color: #0066cc; text-decoration: none; font-weight: bold;">ðŸ“Š View Starburst Map</a>
    </div>
    <label for="facility-type-filter">Filter by Facility Type:</label>
    <select id="facility-type-filter">
      <option value="">All Types</option>
      <option value="Agronomy Center">Agronomy Center</option>
      <option value="Ethanol Plant">Ethanol Plant</option>
      <option value="Farm Supply Store">Farm Supply Store</option>
      <option value="Feedlot">Feedlot</option>
      <option value="Fertilizer Plant">Fertilizer Plant</option>
      <option value="Fuel Station">Fuel Station</option>
      <option value="Grain Elevator">Grain Elevator</option>
      <option value="Seed & Feed Mill">Seed & Feed Mill</option>
      <option value="Service Station">Service Station</option>
    </select>
  </div>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha512-LkS2G8HkzHnFJVpaz6RtWLpmjHtkobaN6D+PfYZ7R6pujISiFDUFxuDrPq3NbS1RyCBj3Tz6kGKuX3s8mZ8nKw=="
    crossorigin=""
  ></script>

  <script>
    // --- CONFIG SECTION: change these values as needed ---

    // Dynamically detect host from current page URL
    // This uses the same host as the web page, so it works with any IP
    const currentHost = window.location.hostname;
    const GEOSERVER_PORT = 8090; // GeoServer port from docker-compose.yml
    const GEOSERVER_URL = `http://${currentHost}:${GEOSERVER_PORT}/geoserver`;

    // Workspace:name of your WMS layer (e.g. aginfo:facility)
    const WMS_LAYER_NAME = "aginfo:facility";

    // Initial map center (Kansas) and zoom
    const INITIAL_CENTER = [38.5, -98.5]; // [lat, lon]
    const INITIAL_ZOOM = 7;


    // --- MAP SETUP ---
    
    // Wait for DOM to be ready
    let map;
    let osm;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Create the map
        map = L.map("map").setView(INITIAL_CENTER, INITIAL_ZOOM);

        // OSM base layer
        osm = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Load facilities when map is ready
        map.whenReady(function() {
            console.log('Map initialized');
            console.log('GeoServer URL:', GEOSERVER_URL);
            console.log('Loading facilities from GeoServer WFS...');
            loadFacilities();
        });
        
        // Add filter change event listener
        const filterSelect = document.getElementById('facility-type-filter');
        if (filterSelect) {
            filterSelect.addEventListener('change', function() {
                const selectedType = this.value;
                console.log('Filter changed to:', selectedType || 'All Types');
                currentFilter = selectedType;
                loadFacilities(selectedType);
            });
        }
    });

    // HTML escaping function to prevent XSS vulnerabilities
    function escapeHtml(text) {
        if (text == null) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Store markers for potential cleanup
    let facilityMarkers = [];
    
    // Current filter value
    let currentFilter = '';

    // Function to load facilities dynamically from GeoServer WFS
    async function loadFacilities(filterType = '') {
        try {
            // Build WFS GetFeature request URL
            let wfsUrl = `${GEOSERVER_URL}/wfs?` +
                `service=WFS&` +
                `version=1.1.0&` +
                `request=GetFeature&` +
                `typeName=${WMS_LAYER_NAME}&` +
                `outputFormat=application/json&` +
                `srsName=EPSG:4326`;
            
            // Add CQL filter if a facility type is selected
            // Try different possible field names - GeoServer will ignore if field doesn't exist
            if (filterType && filterType !== '') {
                // Escape single quotes in the filter value for CQL
                const escapedFilter = filterType.replace(/'/g, "''");
                // Try common field name patterns - if CQL fails, client-side filter will handle it
                wfsUrl += `&CQL_FILTER=facility_type_name='${escapedFilter}'`;
            }

            console.log('Fetching facilities from:', wfsUrl);
            
            const response = await fetch(wfsUrl);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const geojson = await response.json();
            
            // Clear existing markers
            if (map) {
                facilityMarkers.forEach(marker => map.removeLayer(marker));
            }
            facilityMarkers = [];
            
            // Process GeoJSON features
            if (geojson.features && geojson.features.length > 0) {
                geojson.features.forEach(feature => {
                    // Skip features with null or missing geometry
                    if (!feature.geometry || !feature.geometry.coordinates) {
                        console.warn('Skipping feature with missing geometry:', feature);
                        return;
                    }
                    
                    const coords = feature.geometry.coordinates; // [lng, lat] in GeoJSON
                    
                    // Validate coordinates array has at least 2 elements (lng, lat)
                    if (!Array.isArray(coords) || coords.length < 2 || 
                        typeof coords[0] !== 'number' || typeof coords[1] !== 'number') {
                        console.warn('Skipping feature with invalid coordinates:', feature);
                        return;
                    }
                    
                    const props = feature.properties;
                    
                    // Client-side filtering by facility type (fallback if CQL filter doesn't work)
                    // Check various possible field names for facility type
                    const facilityType = props.facility_type_name || 
                                       props.facility_type || 
                                       props.facilitytype_name ||
                                       props.type_name ||
                                       '';
                    
                    // Debug: log first feature to see available properties
                    if (facilityMarkers.length === 0 && geojson.features.length > 0) {
                        console.log('Sample feature properties:', Object.keys(props));
                        console.log('Facility type field value:', facilityType || 'NOT FOUND');
                    }
                    
                    // If a filter is set and this feature doesn't match, skip it
                    if (filterType && filterType !== '' && facilityType !== filterType) {
                        return;
                    }
                    
                    // Build popup content with escaped HTML to prevent XSS
                    const popupContent = `
                        <b>${escapeHtml(props.name || 'Unknown')}</b><br>
                        ${escapeHtml(props.city || '')}, ${escapeHtml(props.state || '')}<br>
                        ${escapeHtml(props.address_line1 || '')}
                        ${facilityType ? '<br><small>Type: ' + escapeHtml(facilityType) + '</small>' : ''}
                        ${props.description ? '<br><small>' + escapeHtml(props.description) + '</small>' : ''}
                    `;
                    
                    // Create marker (note: GeoJSON uses [lng, lat], Leaflet uses [lat, lng])
                    if (map) {
                        const marker = L.marker([coords[1], coords[0]])
                            .addTo(map)
                            .bindPopup(popupContent);
                        
                        facilityMarkers.push(marker);
                    }
                });
                
                console.log(`Loaded ${facilityMarkers.length} facilities from database`);
                
                // Fit map to show all facilities
                if (map && facilityMarkers.length > 0) {
                    const group = new L.featureGroup(facilityMarkers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }
            } else {
                console.warn('No facilities found in database');
            }
        } catch (error) {
            console.error('Error loading facilities:', error);
            // Show error message to user (with escaped HTML to prevent XSS)
            if (map) {
                L.popup()
                    .setLatLng([38.5, -99.5])
                    .setContent(`<b>Error loading facilities</b><br>${escapeHtml(error.message)}<br><small>Check console for details</small>`)
                    .openOn(map);
            }
        }
    }
    

    // Optional: Layer control (removed since we're using dynamic markers now)
  </script>
</body>
</html>
